steps:
  # Step to fetch the secret and create the envfile
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk:slim'
    id: 'Prepare envfile'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "$(gcloud secrets versions access latest --secret='my-secret-env-file' --format='get(payload.data)' | tr '_-' '/+' | base64 -d)" > envfile

  # Step to build the Docker image
  - name: 'gcr.io/cloud-builders/docker'
    id: 'Build'
    args:
      - build
      - '--no-cache'
      - '-t'
      - 'gcr.io/$PROJECT_ID/i-dine-ui:$SHORT_SHA'
      - '.'
      - '-f'
      - 'Dockerfile'

  # Step to push the image to Container Registry
  - name: 'gcr.io/cloud-builders/docker'
    id: 'Push'
    args:
      - push
      - 'gcr.io/$PROJECT_ID/i-dine-ui:$SHORT_SHA'

images:
  - 'gcr.io/$PROJECT_ID/i-dine-ui:$SHORT_SHA'

options:
  substitutionOption: ALLOW_LOOSE
  logging: CLOUD_LOGGING_ONLY
tags:
  - gcp-cloud-build-deploy-cloud-run
  - gcp-cloud-build-deploy-cloud-run-managed

